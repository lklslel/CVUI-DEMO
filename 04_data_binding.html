<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CVUI Demo — Windows with Data Binding</title>
<style>
  body { background:#222; color:#eee; display:flex; flex-direction:column; align-items:center; padding:20px; font-family:sans-serif; }
  canvas { background:#333; box-shadow:0 4px 12px rgba(0,0,0,0.6); }
</style>
</head>
<body>
<h2>CVUI — Window System with Data Binding (Slider + Textbox)</h2>
<canvas id="cvui" width="1000" height="600"></canvas>
<script>
const canvas = document.getElementById('cvui');
const ctx = canvas.getContext('2d');

// Shared data object
const sharedData = { value: 50, text: "" };

// --- Base Window ---
function createWindow(x,y,w,h,title,isFPS=false) {
  return {
    x,y,w,h,title,
    dragging:false, offsetX:0, offsetY:0,
    children:[],
    fps:0, frameCount:0, lastFpsUpdate:performance.now(),
    isFPS:isFPS,
    hitTest(mx,my){ return (mx>this.x && mx<this.x+this.w && my>this.y && my<this.y+30); },
    onPointerDown(mx,my){
      if(this.hitTest(mx,my)){ this.dragging=true; this.offsetX=mx-this.x; this.offsetY=my-this.y; }
      for(const c of this.children) c.onPointerDown(mx-this.x,my-this.y);
    },
    onPointerMove(mx,my){
      if(this.dragging){ this.x=mx-this.offsetX; this.y=my-this.offsetY; }
      for(const c of this.children) c.onPointerMove(mx-this.x,my-this.y);
    },
    onPointerUp(mx,my){
      this.dragging=false;
      for(const c of this.children) c.onPointerUp(mx-this.x,my-this.y);
    },
    updateFPS(){
      const now=performance.now();
      this.frameCount++;
      if(now-this.lastFpsUpdate>=1000){ this.fps=this.frameCount; this.frameCount=0; this.lastFpsUpdate=now; }
    },
    draw(ctx){
      ctx.fillStyle="#eee"; ctx.fillRect(this.x,this.y,this.w,this.h);
      ctx.fillStyle="#4a76f0"; ctx.fillRect(this.x,this.y,this.w,30);
      ctx.fillStyle="#fff"; ctx.font="16px sans-serif"; ctx.fillText(this.title,this.x+8,this.y+20);
      ctx.save(); ctx.translate(this.x,this.y);
      for(const c of this.children) c.draw(ctx);
      ctx.restore();
      if(this.isFPS){ this.updateFPS(); ctx.fillStyle="#222"; ctx.font="14px monospace"; ctx.fillText("FPS: "+this.fps,this.x+10,this.y+60); }
    }
  };
}

// --- Label ---
function createLabel(x,y,textProvider){
  return {
    x,y,textProvider,
    onPointerDown(){},onPointerMove(){},onPointerUp(){},
    draw(ctx){ ctx.fillStyle="#000"; ctx.font="14px sans-serif"; ctx.fillText(this.textProvider(),this.x,this.y+15); }
  };
}

// --- Slider ---
function createSlider(x,y,w,h,min,max,value,onChange){
  return {
    x,y,w,h,min,max,value,onChange,dragging:false,
    hitTest(mx,my){return mx>this.x && mx<this.x+this.w && my>this.y && my<this.y+this.h;},
    onPointerDown(mx,my){ if(this.hitTest(mx,my)){this.dragging=true; this.updateValue(mx);} },
    onPointerMove(mx,my){ if(this.dragging) this.updateValue(mx); },
    onPointerUp(){ this.dragging=false; },
    updateValue(mx){ let t=(mx-this.x)/this.w; if(t<0) t=0; if(t>1) t=1; this.value=this.min+t*(this.max-this.min); if(this.onChange) this.onChange(this.value); },
    draw(ctx){
      ctx.fillStyle="#bbb"; ctx.fillRect(this.x,this.y+this.h/2-2,this.w,4);
      let t=(this.value-this.min)/(this.max-this.min); let kx=this.x+t*this.w;
      ctx.fillStyle="#4a76f0"; ctx.beginPath(); ctx.arc(kx,this.y+this.h/2,8,0,Math.PI*2); ctx.fill();
      ctx.fillStyle="#000"; ctx.font="12px sans-serif"; ctx.fillText(this.value.toFixed(0),this.x,this.y+this.h-2);
    }
  };
}

// --- Textbox ---
function createTextbox(x,y,w,h,dataObj,key){
  return {
    x,y,w,h,dataObj,key,focused:false,
    hitTest(mx,my){return mx>this.x && mx<this.x+this.w && my>this.y && my<this.y+this.h;},
    onPointerDown(mx,my){ this.focused=this.hitTest(mx,my); },
    onPointerMove(){}, onPointerUp(){},
    onKeyPress(e){ if(!this.focused) return;
      if(e.key==="Backspace"){ this.dataObj[this.key]=this.dataObj[this.key].slice(0,-1); }
      else if(e.key.length===1){ this.dataObj[this.key]+=e.key; }
    },
    draw(ctx){
      ctx.fillStyle="#fff"; ctx.fillRect(this.x,this.y,this.w,this.h);
      ctx.strokeStyle=this.focused? "#4a76f0":"#000"; ctx.strokeRect(this.x,this.y,this.w,this.h);
      ctx.fillStyle="#000"; ctx.font="14px sans-serif"; ctx.fillText(this.dataObj[this.key],this.x+5,this.y+this.h/2+5);
    }
  };
}

// --- Create windows ---
const winA=createWindow(50,60,280,160,"Window A — Data Viewer");
winA.children.push(createLabel(20,50,()=> "Slider Value: "+sharedData.value.toFixed(0)));
winA.children.push(createLabel(20,80,()=> "Text: "+sharedData.text));

const winB=createWindow(380,200,350,200,"Window B — Input");
const sld=createSlider(20,50,200,40,0,100,sharedData.value,(val)=>{sharedData.value=val;});
const txt=createTextbox(20,120,200,30,sharedData,"text");
winB.children.push(createLabel(20,40,()=> "Adjust Value"));
winB.children.push(sld);
winB.children.push(createLabel(20,110,()=> "Enter Text"));
winB.children.push(txt);

const winFPS=createWindow(780,80,180,100,"Window C — FPS Meter",true);

const windows=[winA,winB,winFPS];

// pointer events
let activeWin=null;
canvas.addEventListener('pointerdown', e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width);
  const my=(e.clientY-rect.top)*(canvas.height/rect.height);
  for(let i=windows.length-1;i>=0;i--){
    const w=windows[i]; w.onPointerDown(mx,my);
    if(w.dragging){ activeWin=w; windows.splice(i,1); windows.push(w); break; }
  }
});
canvas.addEventListener('pointermove', e=>{
  if(!activeWin) return;
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width);
  const my=(e.clientY-rect.top)*(canvas.height/rect.height);
  activeWin.onPointerMove(mx,my);
});
canvas.addEventListener('pointerup', e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width);
  const my=(e.clientY-rect.top)*(canvas.height/rect.height);
  if(activeWin) activeWin.onPointerUp(mx,my);
  activeWin=null;
});

// key input for textbox
document.addEventListener('keydown', e=>{
  for(const w of windows){ for(const c of w.children){ if(c.onKeyPress) c.onKeyPress(e); } }
});

// main loop
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const w of windows) w.draw(ctx);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>